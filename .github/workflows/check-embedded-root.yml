name: Check embedded root

on:
  workflow_dispatch:
  schedule:
    - cron: '13 13 * * 3'

jobs:
  check-embedded-root:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.x"
          cache: "pip"
          cache-dependency-path: pyproject.toml

      - name: Setup environment
        run: make dev

      - name: Check if embedded root is up-to-date
        run: |
          make update-embedded-root
          git diff --exit-code


      - if: failure()
        name: Create an issue if embedded root is not up-to-date
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const repo = context.repo.owner + "/" + context.repo.repo
            const body = `
            The Sigstore [TUF repository](https://tuf-repo-cdn.sigstore.dev/) contents have changed: the data embedded
            in sigstore-python sources can be updated. This is not urgent but will improve cold-cache performance.
            
            Run \`make update-embedded-root\` to update the embedded data.
            
            This issue was filed by _${context.workflow}_ [workflow run](${context.serverUrl}/${repo}/actions/runs/${context.runId}).
            `

            const issues = await github.rest.search.issuesAndPullRequests({
              q: "label:embedded-root-update+state:open+type:issue+repo:" + repo,
            })
            if (issues.data.total_count > 0) {
              console.log("Issue for embedded root update exists already.")
            } else {
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: "Embedded TUF root is not up-to-date",
                labels: ["embedded-root-update"],
                body: body,
              })
              console.log("New issue created.")
            }
